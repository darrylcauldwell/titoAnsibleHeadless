---
- hosts:
    localhost
  become: yes
  become_method: sudo
  gather_facts: true
  vars:
    root_db_password: Tito2016
  tasks:
      - name: Ensure SELinux is disabled
        lineinfile:
          path: /etc/selinux/config
          regexp: '^SELINUX='
          line: SELINUX=disabled

      - name: Install MySQL 5.7 repo
        yum:
          name: http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm
          state: present

      - name: Install MySQL client
        yum:
          name: mysql
          state: present
          
      - name: Install MySQL server
        yum:
          name: mysql-server
          state: present
          
      - name: Start service mysqld
        service:
          name: mysqld
          state: started

      - name: Reset the root@localhost password
        shell: mysql -u root -p$(cat /var/log/mysqld.log | grep "temporary password" | rev | cut -d " " -f 1 | rev) -e "SET PASSWORD FOR root@localhost = '{{ root_db_password }}'" --connect-expired-password;
        
      - name: Configure MySQL client
        copy:
          dest: "~/.my.cnf"
          content: |
            [mysql]
            user = 'root'
            password = '{{ root_db_password }}'
            
      - name: Install python pip
        yum:
          name: python-pip
          state: present

      - name: Install PyMySQL
        pip:
          name: PyMySQL
          state: present

      - name: Create TitoDB database
        mysql_db:
          name: TitoDB
          state: present
          login_user: root
          login_password: '{{ root_db_password }}'
        
      - name: Create DB setup file
        copy:
          dest: "/tmp/Tito.sql"
          content: |
            CREATE TABLE TitoTable (id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, home VARCHAR(50) NOT NULL, work VARCHAR(50) NOT NULL, hour_home_departure VARCHAR(50) NOT NULL, hour_work_departure VARCHAR(50) NOT NULL)
      - name: Create TitoDB TitoTable
        mysql_db:
          name: TitoDB
          state: import
          target: /tmp/Tito.sql
          login_user: root
          login_password: '{{ root_db_password }}'